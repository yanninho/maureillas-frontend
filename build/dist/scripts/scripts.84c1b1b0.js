"use strict";angular.module("maureillasApp").config(["$routeProvider","$locationProvider","$translateProvider","$translatePartialLoaderProvider","$mdGestureProvider","CONFIG",function(a,b,c,d,e,f){angular.forEach(f.VIEWS,function(b,c){angular.forEach(b.pages,function(b,d){a.when(b.path,{templateUrl:"modules/"+c+"/views/"+b.templateHtml,controller:b.controller})})}),a.otherwise({redirectTo:f.VIEWS.main.pages.home.path}),d.addPart("main"),c.useLoader("$translatePartialLoader",{urlTemplate:"modules/{part}/i18n/{lang}.json"}),c.preferredLanguage("fr")}]),angular.module("ngIOS9UIWebViewPatch",["ng"]).config(["$provide",function(a){a.decorator("$browser",["$delegate","$window",function(a,b){function c(a){return/(iPhone|iPad|iPod).* OS 9_\d/.test(a)&&!/Version\/9\./.test(a)}function d(a){function b(){c=null}var c=null,d=a.url;return a.url=function(){return arguments.length?(c=arguments[0],d.apply(a,arguments)):c||d.apply(a,arguments)},window.addEventListener("popstate",b,!1),window.addEventListener("hashchange",b,!1),a}return c(b.navigator.userAgent)?d(a):a}])}]),angular.module("maureillasApp.main",["maureillasApp.common"]),angular.module("maureillasApp.main").controller("HomeCtrl",["$scope","RegisterService",function(a,b){b.register().then(function(b){a.user=b},function(a){})}]),angular.module("maureillasApp.main").controller("MainCtrl",["$scope","MessageService","$translate","$location","$mdSidenav","$mdUtil","CONFIG","MenuService",function(a,b,c,d,e,f,g,h){a.alert=b.getData(),a.toggleMenu=function(){e("right").toggle().then(function(){})},a.menus=[];for(var i in g.VIEWS){var j=g.VIEWS[i];for(var k in j.pages){var l=j.pages[k];l.hideMenu||a.menus.push({selected:!1,icon:l.icon,path:l.path,name:l.label,param:l.param})}}a.indexMenuSelected=0;var m=function(){e("right").close().then(function(){})},n=function(b){a.indexMenuSelected=b,a.menus.forEach(function(a){a.selected=!1}),a.menus[b].selected=!0};a.goTo=function(b){m(),n(b),o(a.menus[b])};var o=function(a){h.go(a)}}]),angular.module("maureillasApp.main").controller("NetworkErrorCtrl",["$scope",function(a){}]),angular.module("maureillasApp.common",[]),angular.module("maureillasApp.common").filter("rssdate",function(){return function(a,b){var c=moment(a);return c.locale("fr").format("dddd D MMMM YYYY")}}),angular.module("maureillasApp.common").factory("RestService",["$q","$http","TechnicalExceptionService","URLS",function(a,b,c,d){var e=a.when("start"),f=function(a,b,c,d){return a},g=function(b,c,d,e){return a.reject()},h=function(a){var b=", attendu : config { url, method } voir https://docs.angularjs.org/api/ng/service/$http";angular.isUndefined(a)&&c["new"]("objet config pour un appel Rest : [undefined]"+b),angular.isUndefined(a.url)&&c["new"]("url dans config pour un appel Rest : [undefined]"+b),angular.isUndefined(a.method)&&c["new"]("method dans config pour un appel Rest : [undefined]"+b)},i=function(a){var b=a.url;return a.backend&&(b=d.urlBackend+a.url),{url:b,cache:!0,method:a.method,data:a.data||"",params:a.params||void 0,headers:{Authorization:"Basic key:"+d.security}}};return{call:function(a){h(a);var c=i(a),d=e.then(function(){return b(c).success(f).error(g)});return d}}}]),angular.module("maureillasApp.common").factory("DeviceService",function(){var a=function(){return navigator.userAgent.match(/Android/i)},b=function(){return navigator.userAgent.match(/BlackBerry/i)},c=function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},d=function(){return navigator.userAgent.match(/Opera Mini/i)},e=function(){return navigator.userAgent.match(/IEMobile/i)},f=function(){return a()||b()||c()||d()||e()};return{isMobile:function(){return f()}}}),angular.module("maureillasApp.common").factory("NetworkService",function(){return{networkConnectionExist:function(){var a=!0;return void 0!==navigator&&void 0!==navigator.connection&&(a="No network connection"!=navigator.connection.type),a}}}),angular.module("maureillasApp.common").factory("TechnicalExceptionService",function(){return{"new":function(a){function b(a){this.name="TechnicalException",this.message=a}throw b.prototype=new Error,b.prototype.constructor=b,new b(a)}}}),angular.module("maureillasApp.common").factory("$exceptionHandler",["MessageService",function(a){return function(b,c){console.log(b);var d=a.newMessage();d.textes=[b.message],d.type=a.getTypesMessages().DANGER,a.setMessage(d)}}]),angular.module("maureillasApp.common").constant("CONFIG",{VIEWS:{main:{definition:{path:"main"},pages:{home:{label:"navigation.HOME",path:"/home",templateHtml:"home.html",controller:"HomeCtrl",icon:"images/ic_home_48px.svg"},networkError:{label:"navigation.NETWORK_ERROR",path:"/networkError",templateHtml:"networkError.html",controller:"NetworkErrorCtrl",hideMenu:!0}}},feeds:{definition:{path:"feeds"},pages:{actus:{label:"navigation.NEWS",path:"/actus",templateHtml:"feeds.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},agenda:{label:"navigation.AGENDA",path:"/agenda",templateHtml:"agenda.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},practicalNews:{label:"navigation.PRACTICAL_NEWS",path:"/practicalNews",templateHtml:"direct.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},historicalPatrimony:{label:"navigation.HISTORICAL_PATRIMONY",path:"/historicalPatrimony",templateHtml:"direct.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},naturalHeritage:{label:"navigation.NATURAL_HERITAGE",path:"/naturalHeritage",templateHtml:"direct.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},accomodation:{label:"navigation.ACCOMMODATION",path:"/accomodation",templateHtml:"direct.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},restaurants:{label:"navigation.RESTAURANTS",path:"/restaurants",templateHtml:"direct.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"},administrativeProcedures:{label:"navigation.ADMINISTRATIVE_PROCEDURES",path:"/administrativeProcedures",templateHtml:"direct.html",controller:"FeedsCtrl",icon:"images/ic_bookmark_48px.svg"}}},subscription:{definition:{path:"subscription"},pages:{subscription:{label:"navigation.SUBSCRIPTION",path:"/subscription",templateHtml:"subscription.html",controller:"SubscriptionCtrl",icon:"images/ic_bookmark_48px.svg"}}}},FEEDS:{agenda:{url:"http://www.maureillas.fr/evenements/feed/"},actus:{url:"http://www.maureillas.fr/category/mobile/feed/"},practicalNews:{request:{url:"http://www.maureillas.fr/flux/",method:"GET",params:{id:"318"}}},historicalPatrimony:{request:{url:"http://www.maureillas.fr/flux/",method:"GET",params:{id:"110"}}},naturalHeritage:{request:{url:"http://www.maureillas.fr/flux/",method:"GET",params:{id:"116"}}},accomodation:{request:{url:"http://www.maureillas.fr/flux/",method:"GET",params:{id:"86"}}},restaurants:{request:{url:"http://www.maureillas.fr/flux/",method:"GET",params:{id:"88"}}},administrativeProcedures:{request:{url:"http://www.maureillas.fr/flux/",method:"GET",params:{id:"66"}}}},REMOTE:{googleFeedsService:{url:"http://ajax.googleapis.com/ajax/services/feed/load",method:"JSONP",params:{v:"1.0",callback:"JSON_CALLBACK"}},pushService:{GCM:{key:"904172923113"}},maureillasService:{users:{createUser:{url:"/v1/users",method:"PUT"},updateUser:{url:"/v1/users/{ID}",method:"POST"}},feeds:{getAll:{url:"/v1/feeds",method:"GET"}}}},URLS:{DEVELOPMENT:{urlBackend:"http://127.0.0.1:49166",security:"f4P8I3CcCYoT15j6V2V1vn4NCRDIc5Rb"},TEST:{urlBackend:"http://localhost:49156",security:"2LG5D0Ge0Lk31nrE3FN1J1EpqgzVpJzC"},PRODUCTION:{urlBackend:"http://maureillas.herokuapp.com",security:"dvZ3UA6BqgUsLrP82Kj5bDCu6jcsDZ35"}}}).constant("URLS",{urlBackend:"http://maureillas.herokuapp.com",security:"dvZ3UA6BqgUsLrP82Kj5bDCu6jcsDZ35"}),angular.module("maureillasApp.common").factory("MessageService",["$injector",function(a){var b={PRIMARY:"alert-primary",SUCCESS:"alert-success",WARNING:"alert-warning",DANGER:"alert-danger"},c={message:{textes:void 0,type:b.PRIMARY,json:!1,timestamp:5e3}},d=function(d,e,f){c.message.type=d,c.message.textes=[e];var g=a.get("$timeout");g(function(){c.message.textes=void 0,c.message.type=b.PRIMARY,c.message.json=!1},c.message.timestamp)};return{newMessage:function(){return{textes:void 0,type:b.PRIMARY,json:!1,timestamp:5e3}},getTypesMessages:function(){return b},getData:function(){return c},setMessage:function(d){if(!angular.isUndefined(d)&&!angular.isUndefined(d.textes)){c.message.textes=d.textes,angular.isUndefined(d.type)||(c.message.type=d.type),angular.isUndefined(d.json)||(c.message.json=d.json),angular.isUndefined(d.timestamp)||(c.message.timestamp=d.timestamp);var e=a.get("$timeout");e(function(){c.message.textes=void 0,c.message.type=b.PRIMARY,c.message.json=!1},c.message.timestamp)}},setSuccess:function(a){d(b.SUCCESS,a,5e3)},setError:function(a){d(b.DANGER,a,5e3)}}}]),angular.module("maureillasApp.common").factory("MenuService",["$location","CONFIG","_",function(a,b,c){return{go:function(b){a.url(a.path()),angular.isDefined(b.param)?a.path(b.path).search(b.param):a.path(b.path)},find:function(a){var d=b.VIEWS.main.pages.home;return c.each(b.VIEWS,function(b){c.contains(c.keys(b.pages),a)&&(d=b.pages[a])}),d}}}]),angular.module("maureillasApp.common").factory("_",["$window",function(a){return a._}]),angular.module("maureillasApp.feeds",["maureillasApp.common"]).config(["$translatePartialLoaderProvider","CONFIG",function(a,b){a.addPart(b.VIEWS.feeds.definition.path)}]),angular.module("maureillasApp.feeds").factory("FeedListService",["RestService","CacheFactory","CONFIG",function(a,b,c){var d=function(){return b.get("feeds")||b.createCache("feeds",{storageMode:"localStorage"}),b.get("feeds")},e={},f=d(),g="",h=function(a){f.put(g,a)},i=function(){e=angular.isDefined(f.get(g))?f.get(g):{}},j=function(a,b){var d=c.REMOTE.googleFeedsService;return d.params.q=a.url,d.params.num=b,d},k=function(a){var b=a.request;return b},l=function(a){e=a.data.responseData.feed,h(e)},m=function(a){e=a.data,h(e)},n=function(b,d){g=b,i();var h=c.FEEDS[b],n={},o=null;angular.isUndefined(h.request)?(n=j(h,d),o=l):(n=k(h),o=m);var p=a.call(n);return p.then(o,function(){angular.isUndefined(f.get(g))&&(e={})})};return{get:function(){return e},fetchFeeds:function(a,b){return n(a,b)}}}]),angular.module("maureillasApp.feeds").controller("FeedsCtrl",["$scope","$location","FeedListService","CONFIG","MessageService",function(a,b,c,d,e){a.feedList=c.get;var f=b.path().substring(1,b.path().length);if(!angular.isUndefined(f)){var g=f;a.title=d.VIEWS.feeds.pages[g].label,a.loading=!0;var h=c.fetchFeeds(g,10),i=function(b){a.loading=!1},j=function(){a.loading=!1,e.setError("Erreur de communication réseau. Vérifiez votre connexion.")};h.then(i,j)}}]),angular.module("maureillasApp.subscription",["maureillasApp.common","maureillasApp.server"]).config(["$translatePartialLoaderProvider","CONFIG",function(a,b){a.addPart(b.VIEWS.subscription.definition.path)}]),angular.module("maureillasApp.subscription").controller("SubscriptionCtrl",["$scope","RegisterService","UserService","MessageService","$translate",function(a,b,c,d,e){a.loading=!1,a.user=c.getUser,angular.isUndefined(a.user.info)&&(a.loading=!0,b.register().then(function(b){a.loading=!1},function(b){var c=d.newMessage();c.type=d.getTypesMessages().DANGER,c.textes=[b],d.setMessage(c),a.loading=!1})),a.update=function(){var a=c.update();a.then(function(){e("subscription.UPDATE_OK").then(function(a){var b=d.newMessage();b.type=d.getTypesMessages().SUCCESS,b.textes=[a],d.setMessage(b)})},function(a){var b=d.newMessage();b.type=d.getTypesMessages().DANGER,b.textes=[a],d.setMessage(b)})}}]),angular.module("maureillasApp.push",["maureillasApp.common","maureillasApp.server"]).config(["$translatePartialLoaderProvider",function(a){a.addPart("push")}]),angular.module("maureillasApp.push").factory("PushService",["$q","$window","CONFIG","DeviceService",function(a,b,c,d){var e={};return d.isMobile()&&(e="android"==device.platform||"Android"==device.platform?{senderID:c.REMOTE.pushService.GCM.key,ecb:"onNotificationGCM"}:{badge:"true",sound:"true",alert:"true",ecb:"onNotificationAPN"}),{register:function(){var b=a.defer();return d.isMobile()?angular.isDefined(window.plugins)?window.plugins.pushNotification.register(function(a){b.resolve(a)},function(a){b.reject(a)},e):b.reject("window.plugin not defined, register not possible"):b.reject("not on mobile device"),b.promise}}}]),angular.module("maureillasApp.push").controller("PushCtrl",["$rootScope","$location","$window","UserService","MenuService","MessageService",function(a,b,c,d,e,f){c.onNotificationGCM=function(b){switch(b.event){case"registered":b.regid.length>0&&d.setRegisterID(b.regid);break;case"message":if(b.foreground){var c=new Media("/android_asset/www/"+b.soundname);c.play()}else b.coldstart;a.$apply(function(){var a=b.payload.category,c=e.find(a);e.go(c)});break;case"error":f.setError("ERROR -> MSG:"+b.msg);break;default:f.setError("EVENT -> Unknown, an event was received and we do not know what it is")}},c.successIosHandler=function(a){console.log("result = "+a)},c.onNotificationAPN=function(b){if(b.alert&&(console.log("push-notification: "+b.alert),navigator.notification.alert(b.alert)),b.sound){var c=new Media(b.sound);c.play()}b.badge&&pushNotification.setApplicationIconBadgeNumber("successIosHandler",b.badge),a.$apply(function(){var a=e.find("actus");e.go(a)})}}]),angular.module("maureillasApp.server",["maureillasApp.common"]),angular.module("maureillasApp.server").factory("UserService",["$q","RestService","CONFIG","PlatformService",function(a,b,c,d){var e={registerID:void 0,info:void 0},f=function(){var f=e.registerID;if(angular.isDefined(f)){var g=c.REMOTE.maureillasService.users.createUser;g.data={user:{id:f,platform:d.getPlatform()}},g.backend=!0;var h=b.call(g);return h.then(function(a){return e.info=a.data,e.info})}var i=a.defer();return i.reject("No Register ID"),i.promise},g=function(){var a=c.REMOTE.maureillasService.users.updateUser;e.registerID;return a.url=a.url.replace("{ID}",e.info._id),a.data={feeds:e.info.feeds},a.backend=!0,b.call(a)};return{register:function(){return f()},update:function(){return g()},getRegisterID:function(){return e.registerID},setRegisterID:function(a){e.registerID=a},getUser:function(){return e}}}]),angular.module("maureillasApp.server").factory("RegisterService",["$q","UserService","PushService","DeviceService","NetworkService","PlatformService",function(a,b,c,d,e,f){var g=function(a){return a},h=function(){return b.register().then(g,function(c){if(!e.networkConnectionExist()){var d=a.defer();return d.reject("No network connection"),d.promise}return angular.isUndefined(b.getRegisterID())?k():h()})},i=function(){return angular.isUndefined(b.getRegisterID())?k():h()},j=function(a){return b.setRegisterID(a),h()},k=function(){var b=i;if(f.isIos()&&(b=j),angular.isDefined(c))return c.register().then(b,function(b){if(!e.networkConnectionExist()){var c=a.defer();return c.reject("No network connection"),c.promise}return k()});var d=a.defer();return d.reject("No Push service"),d.promise};return{register:function(){if(d.isMobile())return k();var b=a.defer();return b.resolve("Not on mobile device"),console.log("not mobile device"),b.promise}}}]),angular.module("maureillasApp.server").factory("PlatformService",function(){var a=function(){var a="";return a="android"==device.platform||"Android"==device.platform?"GOOGLE":"IOS"};return{getPlatform:function(){return a()},isGoogle:function(){return"GOOGLE"===a()},isIos:function(){return"IOS"===a()}}});